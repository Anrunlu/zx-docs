---
title: 第6天上午_工作流设计实现
author: 周子力
icon: iconfont icon-a-outline-harmony-one
tag: [Python基础]
category: 教学文档
order: 10
---
# Coze平台工作流专题培训方案
## 🎯 培训主题：从"单点调用"到"流程编排"——掌握Coze工作流核心能力

---

## 📋 培训概览

| 时段 | 时间 | 模块 | 核心目标 |
|------|------|------|---------|
| **上午** | 8:00-9:30 | 工作流核心概念与原理 | 理解工作流价值、架构、执行机制 |
| | 9:30-10:45 | 常用节点详解 | 掌握8大核心节点的功能与配置 |
| | 10:45-12:00 | 实例1：简单工作流实战 | 完成"校园天气日报"工作流搭建 |
| **下午** | 14:00-15:30 | 实例2：中等复杂度实战 | 完成"请假审批流程"工作流搭建 |
| | 15:30-16:45 | 实例3：高级应用+调试技巧 | 掌握错误处理、变量管理、性能优化 |
| | 16:45-18:00 | 综合演练与答疑 | 独立完成场景设计+问题解答 |

---

## 📅 上午（8:00-12:00）

### 🔹 8:00-9:30｜工作流核心概念与原理

#### 一、什么是工作流（Workflow）？

```
🎯 定义：
工作流是一种可视化编排工具，用于将多个任务节点（插件/代码/判断/数据库等）
按特定逻辑顺序连接，实现复杂业务的自动化执行。

🔄 对比理解：

【传统智能体】
用户提问 → 大模型理解 → 单次插件调用 → 返回结果
（适合：简单问答、单任务场景）

【工作流智能体】
用户提问 → 意图识别 → [节点1→节点2→...→节点N] → 结果聚合 → 返回结果
（适合：多步骤、有条件、需状态管理的复杂场景）
```

#### 二、为什么需要工作流？

```
✅ 解决三大痛点：

痛点1：单插件能力有限
❌ 天气插件只能查天气，无法结合课表给出"是否适合户外运动"建议
✅ 工作流：天气插件 + 课表查询 + 条件判断 → 综合建议

痛点2：多轮对话状态难管理
❌ 用户说"帮我请假"，需要多轮收集信息，容易丢失上下文
✅ 工作流：表单节点收集→校验→提交→通知，状态自动流转

痛点3：复杂逻辑提示词难维护
❌ 用提示词写"如果A则B，否则如果C则D..."，难以调试和迭代
✅ 工作流：可视化条件分支，逻辑清晰，便于团队协作

📊 适用场景矩阵：
┌────────────────┬────────────────┬────────────────┐
│ 简单场景       │ 中等场景       │ 复杂场景       │
│ (用提示词+插件)│ (用工作流)     │ (用工作流+代码)│
├────────────────┼────────────────┼────────────────┤
│ • 查天气       │ • 请假审批     │ • 智能客服工单 │
│ • 查快递       │ • 活动报名     │ • 数据分析报告 │
│ • 简单计算     │ • 日报生成     │ • 多系统对接   │
└────────────────┴────────────────┴────────────────┘
```

#### 三、Coze工作流架构详解

```
🏗️ 执行原理图：

┌─────────────────────────────────────┐
│ 1. 触发阶段                          │
│ • 用户输入 / 定时任务 / API调用     │
│ • 解析输入参数，初始化工作流上下文  │
└────────┬────────────────────────────┘
         ▼
┌─────────────────────────────────────┐
│ 2. 节点执行阶段（核心）              │
│ • 按拓扑顺序执行节点                │
│ • 节点间通过"变量"传递数据          │
│ • 支持并行执行（无依赖的分支）      │
└────────┬────────────────────────────┘
         ▼
┌─────────────────────────────────────┐
│ 3. 结果聚合阶段                      │
│ • 收集各分支输出                    │
│ • 执行最终格式化/汇总               │
└────────┬────────────────────────────┘
         ▼
┌─────────────────────────────────────┐
│ 4. 返回阶段                          │
│ • 输出JSON/自然语言给用户           │
│ • 记录执行日志，便于追踪调试        │
└─────────────────────────────────────┘

🔑 核心概念：
• 节点（Node）：最小执行单元，如"调用天气插件"
• 连线（Edge）：定义节点执行顺序和数据流向
• 变量（Variable）：节点间传递数据的载体
• 上下文（Context）：整个工作流执行过程中的共享状态
```

#### 四、工作流 vs 其他能力对比

| 能力 | 适用场景 | 优势 | 局限 |
|------|---------|------|------|
| **提示词** | 简单规则、文本生成 | 轻量、易修改 | 逻辑复杂时难维护 |
| **插件** | 单次外部API调用 | 实时数据、专业计算 | 无法处理多步骤逻辑 |
| **知识库** | 静态信息检索 | 语义理解、精准匹配 | 无法执行操作/计算 |
| **数据库** | 个人数据存储 | 结构化、可查询 | 需配合其他能力使用 |
| **✅ 工作流** | **多步骤业务编排** | **可视化、可调试、可复用** | **学习曲线稍陡** |

> 💡 **关键认知**：工作流不是替代其他能力，而是"胶水"，将提示词、插件、知识库、数据库等能力按需组合，实现1+1>2的效果[[1]]。

---

### 🔹 9:30-10:45｜常用节点详解

#### 一、8大核心节点全景图

```
┌─────────────────────────────────────┐
│ 🟢 控制类节点                        │
│ • Start（开始）：定义输入参数        │
│ • End（结束）：定义输出格式          │
│ • Condition（条件）：if/else分支    │
│ • Loop（循环）：遍历列表数据         │
├─────────────────────────────────────┤
│ 🔵 能力类节点                        │
│ • Plugin（插件）：调用外部API        │
│ • Knowledge（知识库）：检索静态知识  │
│ • Database（数据库）：CRUD操作      │
│ • Code（代码）：执行Python/JS逻辑   │
├─────────────────────────────────────┤
│ 🟡 辅助类节点                        │
│ • Variable（变量）：赋值/更新/读取  │
│ • Log（日志）：记录执行信息（调试用）│
└─────────────────────────────────────┘
```

#### 二、节点配置详解（含示例）

##### 1️⃣ Start节点（开始）
```
🎯 作用：定义工作流的输入接口

📋 配置示例（请假审批工作流）：
{
  "inputs": {
    "user_id": {"type": "string", "required": true, "desc": "申请人ID"},
    "leave_type": {"type": "string", "required": true, "enum": ["事假", "病假", "年假"], "desc": "请假类型"},
    "start_date": {"type": "string", "format": "YYYY-MM-DD", "desc": "开始日期"},
    "end_date": {"type": "string", "format": "YYYY-MM-DD", "desc": "结束日期"},
    "reason": {"type": "string", "max_length": 200, "desc": "请假原因"}
  }
}

💡 最佳实践：
• 必填项用required标注，避免下游节点空指针
• 枚举类型用enum限定，减少校验逻辑
• 添加desc说明，便于团队协作理解
```

##### 2️⃣ Plugin节点（插件调用）
```
🎯 作用：调用已集成的外部插件

📋 配置示例（天气查询）：
┌─────────────────────────────────────┐
│ 插件选择：和风天气                  │
│ 输入参数映射：                      │
│ • location → {{start.city}}         │
│ • date → {{start.date \| default("today")}} │
│ 输出字段提取：                      │
│ • temp → weather.temp              │
│ • condition → weather.condition    │
│ • precipitation → weather.rain_prob│
└─────────────────────────────────────┘

⚠️ 注意事项：
• 参数类型必须匹配（字符串/数字/布尔）
• 添加超时设置（默认5秒，复杂插件可延长）
• 配置fallback值：插件失败时返回默认数据
```

##### 3️⃣ Condition节点（条件分支）
```
🎯 作用：根据表达式结果路由到不同分支

📋 配置示例（请假天数校验）：
┌─────────────────────────────────────┐
│ 分支1：天数≤3天                    │
│ 表达式：{{days}} <= 3              │
│ 执行：直接提交审批                  │
├─────────────────────────────────────┤
│ 分支2：3天<天数≤7天                │
│ 表达式：{{days}} > 3 AND {{days}} <= 7 │
│ 执行：需辅导员确认                  │
├─────────────────────────────────────┤
│ 分支3：天数>7天                    │
│ 表达式：{{days}} > 7               │
│ 执行：需院系领导审批+补充材料      │
└─────────────────────────────────────┘

💡 表达式语法：
• 比较：==, !=, >, <, >=, <=
• 逻辑：AND, OR, NOT
• 函数：contains(), starts_with(), length()
• 示例：{{status}} == "pending" AND contains({{reason}}, "急诊")
```

##### 4️⃣ Code节点（自定义代码）
```
🎯 作用：执行Python/JavaScript处理复杂逻辑

📋 配置示例（计算请假天数）：
```python
def main(start_date, end_date):
    from datetime import datetime
    
    # 解析日期
    d1 = datetime.strptime(start_date, "%Y-%m-%d")
    d2 = datetime.strptime(end_date, "%Y-%m-%d")
    
    # 计算天数（含首尾）
    days = (d2 - d1).days + 1
    
    # 校验：不能早于今天
    if d1 < datetime.now().replace(hour=0, minute=0, second=0):
        return {"valid": False, "error": "开始日期不能早于今天"}
    
    return {"valid": True, "days": days}
```

🔧 输入/输出定义：
• 输入：start_date(string), end_date(string)
• 输出：valid(boolean), days(number), error(string)

⚠️ 安全限制：
❌ 禁止网络请求、文件操作、导入非标准库
✅ 允许：math/re/json/datetime等标准库
```

##### 5️⃣ Variable节点（变量管理）
```
🎯 作用：在工作流中暂存/更新/读取中间结果

📋 使用场景：
┌─────────────────────────────────────┐
│ 场景1：暂存计算结果                 │
│ • 代码节点算出days=5                │
│ • 存入变量：workflow.days = 5       │
│ • 下游多个节点都可引用{{workflow.days}}│
├─────────────────────────────────────┤
│ 场景2：累积列表数据                 │
│ • 循环中：workflow.approval_chain.append("辅导员")│
│ • 最终输出完整审批链                │
├─────────────────────────────────────┤
│ 场景3：标记执行状态                 │
│ • 变量：workflow.has_error = false │
│ • 异常时设为true，结束节点据此返回错误│
└─────────────────────────────────────┘

💡 变量作用域：
• 工作流级变量：整个流程共享，用workflow.xxx引用
• 节点级输出：仅下游节点可用，用{{node_id.output.xxx}}引用
```

##### 6️⃣ Knowledge节点（知识库检索）
```
🎯 作用：从文本/表格/图片知识库中检索相关信息

📋 配置示例（查询请假政策）：
┌─────────────────────────────────────┐
│ 知识库选择：XX大学学生手册          │
│ 检索模式：语义检索（默认）          │
│ 查询语句：{{leave_type}}请假规定    │
│ 召回数量：Top 3                    │
│ 相似度阈值：0.65                   │
│ 输出字段：content, source_chapter  │
└─────────────────────────────────────┘

✅ 最佳实践：
• 在提示词中告知AI"优先引用知识库内容"
• 对检索结果做去重/排序/摘要处理
• 无结果时返回友好提示+人工渠道
```

##### 7️⃣ Database节点（数据库操作）
```
🎯 作用：对个人/业务数据进行CRUD操作

📋 配置示例（记录请假申请）：
```sql
-- 插入新申请记录
INSERT INTO leave_applications (
  user_id, leave_type, start_date, end_date, 
  days, reason, status, created_at
) VALUES (
  {{start.user_id}}, {{start.leave_type}}, 
  {{start.start_date}}, {{start.end_date}},
  {{calc_days.output.days}}, {{start.reason}},
  'pending', NOW()
)
```

🔧 参数绑定：
• 用{{node.output.field}}引用上游结果
• 支持批量操作：INSERT INTO ... VALUES (...), (...), ...

⚠️ 权限控制：
• 默认启用user_id隔离，A用户无法查B用户数据
• 敏感操作（删除/批量更新）需二次确认
```

##### 8️⃣ End节点（结束）
```
🎯 作用：定义工作流的最终输出格式

📋 配置示例（请假审批结果）：
```json
{
  "success": {{workflow.valid}},
  "message": "{% if workflow.valid %}✅ 申请已提交{% else %}❌ {{workflow.error}}{% endif %}",
  "data": {
    "application_id": "{{db_insert.output.id}}",
    "approval_chain": {{workflow.approval_chain}},
    "next_step": "{% if workflow.days <= 3 %}等待辅导员审核{% elif workflow.days <=7 %}等待院系审核{% else %}请补充材料后提交{% endif %}"
  },
  "policy_reference": "{{knowledge.output.content}}"
}
```

💡 输出技巧：
• 使用Jinja2模板语法实现条件/循环/格式化
• 关键信息加粗/emoji提升可读性
• 提供action建议（"下一步做什么"）
```

---

### 🔹 10:45-12:00｜实例1：简单工作流实战

#### 🎯 场景：校园天气日报生成器

```
用户需求：
"每天早上告诉我天气+课表+待办事项，帮我规划一天"

📋 工作流设计：
┌─────────────────────────────────────┐
│ Start节点                           │
│ 输入：user_id, date(默认today)     │
└────────┬────────────────────────────┘
         ▼
┌─────────────────────────────────────┐
│ 并行分支（提升响应速度）            │
├─────────────────┬─────────────────┤
▼                 ▼                 ▼
┌─────────┐ ┌─────────┐ ┌─────────┐ │
│天气插件  │ │课表查询  │ │待办事项  │ │
│查实时天气│ │查今日课程│ │查数据库  │ │
└────┬────┘ └────┬────┘ └────┬────┘ │
     │           │           │        │
     ▼           ▼           ▼        │
┌─────────────────────────────────────┐
│ Code节点：数据整合                  │
│ • 格式化天气：25°C晴 → "25度晴☀️"  │
│ • 课程摘要：提取时间+地点+课程名    │
│ • 待办统计：pending数量+高优先级项  │
└────────┬────────────────────────────┘
         ▼
┌─────────────────────────────────────┐
│ Condition节点：智能建议             │
│ if 降水概率>70% → 添加"带伞"提醒   │
│ if 早八课程 → 添加"提前出门"建议   │
│ if 待办>5项 → 添加"优先处理高优"提示│
└────────┬────────────────────────────┘
         ▼
┌─────────────────────────────────────┐
│ End节点：输出日报                   │
│ 模板：                              │
│ "📅 {{date}} 校园日报              │
│ 🌤️ {{weather.summary}}            │
│ 📚 今日课程：{{courses.list}}      │
│ ✅ 待办事项：{{tasks.summary}}     │
│ {{reminder}}                        │
│ 💡 建议：{{suggestion}}"           │
└─────────────────────────────────────┘
```

#### 🔧 实操步骤（学员跟随操作）

```
步骤1：创建新工作流
• 命名：daily_campus_report
• 描述：生成包含天气/课表/待办的校园日报

步骤2：配置Start节点
• 添加输入：user_id(string), date(string, default="today")

步骤3：添加并行插件节点
• 天气插件：和风天气 → 提取temp/condition/precipitation
• 知识库节点：查询"今日课表" → 提取course/time/location
• 数据库节点：SELECT * FROM tasks WHERE user_id={{start.user_id}} AND status='pending'

步骤4：添加Code整合节点
```python
def main(weather, courses, tasks):
    # 天气格式化
    weather_str = f"{weather['temp']}°{weather['condition']}"
    if weather['precipitation'] > 50:
        weather_str += " 🌂"
    
    # 课程摘要（最多3门）
    course_list = [f"{c['time']} {c['name']}({c['location']})" for c in courses[:3]]
    
    # 待办统计
    high_priority = [t for t in tasks if t.get('priority') == 'high']
    task_summary = f"{len(tasks)}项待办"
    if high_priority:
        task_summary += f"（{len(high_priority)}项高优）"
    
    return {
        "weather": weather_str,
        "courses": course_list,
        "tasks": task_summary,
        "need_umbrella": weather['precipitation'] > 70,
        "has_early_class": any("08:" in c['time'] for c in courses)
    }
```

步骤5：添加Condition+End节点
• 条件分支生成reminder变量
• End节点用Jinja2模板输出最终日报

步骤6：测试与调试
• 输入测试数据，观察各节点输出
• 模拟插件失败，验证fallback逻辑
• 优化输出格式，提升可读性
```

#### ✅ 验收标准
```
□ 工作流可成功执行，无报错
□ 并行分支执行时间 < 串行执行（性能优化）
□ 输出格式清晰，关键信息突出
□ 异常场景（如插件超时）有友好降级
□ 变量引用正确，无空指针错误
```

> 💡 **讲师提示**：简单工作流是理解编排逻辑的基础。重点掌握"并行执行"和"变量传递"两个核心概念，后续复杂场景都是它们的组合[[2]]。

---



---
**参考资料**  
[1] Coze官方文档：工作流概念 https://www.coze.cn/docs/workflow  
[2] 最佳实践：并行执行优化 https://www.coze.cn/guide/performance  
[3] 设计模式：状态机在工作流中的应用 https://www.coze.cn/cases/state-machine  
[4] 安全指南：工作流权限与合规 https://www.coze.cn/guide/security